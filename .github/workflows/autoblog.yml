name: Autoblog Update

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      skip_update:
        description: 'Skip the autoblog update step'
        required: false
        default: false
        type: boolean

permissions:
  packages: read
  contents: write
  pull-requests: write

jobs:
  check-pr:
    name: Check Open PRs
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check for existing open Pull Request
        id: check
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if a PR from the branch 'autoblog/update' is already open
          count=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "autoblog/update" \
            --state open \
            --json number \
            --jq 'length')
          
          if [ "$count" -gt 0 ]; then
            echo "::notice::An open Autoblog PR already exists. Skipping execution."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "No open Autoblog PR found. Proceeding."
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  autoblog:
    name: Run Autoblog
    needs: check-pr
    if: needs.check-pr.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/raineblog/mkdocs-autoblog:latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Git is installed
        run: |
          if ! command -v git &> /dev/null; then
            echo "Git not found. Installing..."
            if command -v apt-get &> /dev/null; then
              apt-get update && apt-get install -y git
            elif command -v apk &> /dev/null; then
              apk add --no-cache git
            else
              echo "::warning::Could not install via apt/apk. Assuming git is present or not needed?"
            fi
          fi

      - name: Configure Git Safe Directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Run mkdocs-autoblog
        if: github.event.inputs.skip_update != 'true'
        env:
          PROVIDER: CEREBRAS
          PROVIDER_MODEL: gpt-oss-120b
          PROVIDER_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          BASE_URL: https://raineblog.dpdns.org/whk/
          FEED_URL: https://raineblog.dpdns.org/whk/feed_json_updated.json
        run: mkdocs-autoblog

      - name: Run publish-hashnode
        env:
          HASHNODE_API_KEY: ${{ secrets.HASHNODE_API_KEY }}
          HASHNODE_HOST: https://rainesblog.hashnode.dev/
        run: publish-hashnode

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: [bot] automatic blog updates"
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          branch: autoblog/update
          delete-branch: true
          title: "chore: [bot] Autoblog Updates"
          body: |
            Automated content updates generated by `mkdocs-autoblog`.
            
            This PR includes changes to:
            - `docs/blog/posts/*.md`
            - `.autoblog.json`
          add-paths: |
            docs/blog/posts/*.md
            .autoblog.json
